name: Build C# OPC DA Agent (.NET 4.0 XP Compatible)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build:
    name: Build Windows XP Compatible
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Download NuGet
      run: Invoke-WebRequest -Uri "https://dist.nuget.org/win-x86-commandline/latest/nuget.exe" -OutFile "nuget.exe"

    - name: Configure .NET 4.0
      run: |
        # 确保项目使用.NET 4.0
        (Get-Content "csharp_agent\OPC_DA_Agent.csproj") -replace "v4\.8", "v4.0" | Set-Content "csharp_agent\OPC_DA_Agent.csproj"
        Write-Host "Project configured for .NET Framework 4.0"

    - name: Restore NuGet packages
      run: |
        nuget.exe restore csharp_agent/OPC_DA_Agent.csproj -PackagesDirectory "csharp_agent/packages"

    - name: Build Debug (.NET 4.0)
      run: msbuild csharp_agent/OPC_DA_Agent.csproj /p:Configuration=Debug /p:Platform=AnyCPU /p:TargetFrameworkVersion=v4.0

    - name: Build Release (.NET 4.0)
      run: msbuild csharp_agent/OPC_DA_Agent.csproj /p:Configuration=Release /p:Platform=AnyCPU /p:TargetFrameworkVersion=v4.0

    - name: Verify builds
      run: |
        if (Test-Path "csharp_agent\bin\Debug\OPC_DA_Agent.exe") {
          Write-Host "✓ Debug build successful"
        }
        if (Test-Path "csharp_agent\bin\Release\OPC_DA_Agent.exe") {
          Write-Host "✓ Release build successful"
        }

    - name: Upload Debug Build
      uses: actions/upload-artifact@v4
      with:
        name: OPC_DA_Agent_Debug_XP
        path: csharp_agent/bin/Debug/

    - name: Upload Release Build
      uses: actions/upload-artifact@v4
      with:
        name: OPC_DA_Agent_Release_XP
        path: csharp_agent/bin/Release/
