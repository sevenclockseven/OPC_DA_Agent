name: Build C# OPC DA Agent (Windows XP Compatible - .NET 4.0)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOTNET_FRAMEWORK_VERSION: '4.0'
  NUGET_VERSION: '5.8.1'

jobs:
  build-net40:
    name: Build C# Agent (.NET Framework 4.0 - Windows XP Compatible)
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      with:
        msbuild-version: '17.0'

    - name: Setup NuGet
      run: |
        Write-Host "Downloading NuGet CLI..."
        Invoke-WebRequest -Uri "https://dist.nuget.org/win-x86-commandline/latest/nuget.exe" -OutFile "nuget.exe"
        
        if (Test-Path "nuget.exe") {
          Write-Host "NuGet CLI downloaded successfully"
        } else {
          Write-Host "Failed to download NuGet CLI"
          exit 1
        }

    - name: Restore NuGet packages (.NET 4.0)
      run: |
        Write-Host "Restoring NuGet packages for .NET 4.0..."
        
        # 创建packages目录
        New-Item -ItemType Directory -Force -Path "csharp_agent\packages"
        
        # 清理nuget缓存
        .\nuget.exe locals all -clear
        
        # 恢复包
        .\nuget.exe restore csharp_agent\OPC_DA_Agent.csproj -PackagesDirectory "csharp_agent\packages" -Verbosity detailed
        
        Write-Host "Packages restored successfully"

    - name: Validate project configuration
      run: |
        Write-Host "Validating project configuration..."
        
        # 检查目标框架
        $targetFramework = Select-String -Path "csharp_agent\OPC_DA_Agent.csproj" -Pattern "TargetFrameworkVersion" | ForEach-Object { ($_ -split "v")[1] -replace ">", "" }
        Write-Host "Target Framework: v$targetFramework"
        
        if ($targetFramework -eq "4.0") {
          Write-Host "✓ Project configured for .NET 4.0 (Windows XP compatible)"
        } else {
          Write-Host "✗ Project not configured for .NET 4.0, configuring now..."
          (Get-Content "csharp_agent\OPC_DA_Agent.csproj") -replace "v4\.8", "v4.0" | Set-Content "csharp_agent\OPC_DA_Agent.csproj"
        }

    - name: Build Debug (.NET 4.0)
      run: |
        Write-Host "Building Debug configuration for .NET 4.0..."
        
        # 清理之前的构建
        if (Test-Path "csharp_agent\bin") {
          Remove-Item -Recurse -Force "csharp_agent\bin" -ErrorAction SilentlyContinue
        }
        
        # 构建Debug版本
        msbuild csharp_agent/OPC_DA_Agent.csproj /p:Configuration=Debug /p:Platform=AnyCPU /p:TargetFrameworkVersion=v4.0 /v:detailed

    - name: Verify Debug Build
      run: |
        Write-Host "Verifying Debug build..."
        
        $debugExe = "csharp_agent\bin\Debug\OPC_DA_Agent.exe"
        if (Test-Path $debugExe) {
          Write-Host "✓ Debug build successful: $debugExe"
          
          # 检查文件信息
          Get-Item $debugExe | Select-Object Name, Length, LastWriteTime | Format-List
        } else {
          Write-Host "✗ Debug build failed - executable not found"
          exit 1
        }

    - name: Build Release (.NET 4.0)
      run: |
        Write-Host "Building Release configuration for .NET 4.0..."
        
        # 构建Release版本
        msbuild csharp_agent/OPC_DA_Agent.csproj /p:Configuration=Release /p:Platform=AnyCPU /p:TargetFrameworkVersion=v4.0 /v:detailed

    - name: Verify Release Build
      run: |
        Write-Host "Verifying Release build..."
        
        $releaseExe = "csharp_agent\bin\Release\OPC_DA_Agent.exe"
        if (Test-Path $releaseExe) {
          Write-Host "✓ Release build successful: $releaseExe"
          
          # 检查文件信息
          Get-Item $releaseExe | Select-Object Name, Length, LastWriteTime | Format-List
        } else {
          Write-Host "✗ Release build failed - executable not found"
          exit 1
        }

    - name: Check .NET 4.0 compatibility
      run: |
        Write-Host "Checking .NET 4.0 compatibility..."
        
        # 检查是否使用了不兼容的API
        $issues = @()
        
        $csFiles = Get-ChildItem "csharp_agent\*.cs" -Recurse
        foreach ($file in $csFiles) {
          $content = Get-Content $file.FullName -Raw
          if ($content -match "async\s+Task|await\s+Task") {
            $issues += "async/await patterns detected in $($file.Name)"
          }
          if ($content -match '\$\"') {
            $issues += "string interpolation detected in $($file.Name)"
          }
        }
        
        if ($issues.Count -gt 0) {
          Write-Host "⚠ Potential .NET 4.0 compatibility issues:"
          foreach ($issue in $issues) {
            Write-Host "  - $issue"
          }
        } else {
          Write-Host "✓ No obvious .NET 4.0 compatibility issues detected"
        }

    - name: Upload Debug artifacts (.NET 4.0)
      uses: actions/upload-artifact@v4
      with:
        name: OPC_DA_Agent_Debug_NET40
        path: csharp_agent/bin/Debug/
        retention-days: 30
        
    - name: Upload Release artifacts (.NET 4.0)
      uses: actions/upload-artifact@v4
      with:
        name: OPC_DA_Agent_Release_NET40
        path: csharp_agent/bin/Release/
        retention-days: 90
        
    - name: Create Windows XP Release Package
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        Write-Host "Creating Windows XP release package..."
        
        # 创建发布包目录
        $releaseDir = "OPC_DA_Agent_Windows_XP_NET40"
        New-Item -ItemType Directory -Force -Path $releaseDir
        
        # 复制可执行文件和依赖
        Copy-Item "csharp_agent\bin\Release\*" $releaseDir\
        
        # 创建部署说明
        $readme = @"
# OPC DA Agent - Windows XP Compatible (.NET 4.0)

## System Requirements
- Windows XP Professional SP3 (32-bit or 64-bit)
- .NET Framework 4.0 (must be installed separately)
- Minimum 512MB RAM, 1GB recommended

## Installation
1. Install .NET Framework 4.0 from Microsoft Download Center
2. Extract all files to a directory
3. Create a config.json file with your OPC server settings

## Running
OPC_DA_Agent.exe --config config.json

## Build Information
- Target Framework: .NET Framework 4.0
- Build Date: $(Get-Date)
- Git Commit: $env:GITHUB_SHA
"@
        
        $readme | Out-File -FilePath "$releaseDir\README.txt" -Encoding UTF8
        
        # 创建压缩包
        Compress-Archive -Path "$releaseDir\*" -DestinationPath "OPC_DA_Agent_Windows_XP_NET40.zip"
        
        Write-Host "Release package created: OPC_DA_Agent_Windows_XP_NET40.zip"

    - name: Upload Windows XP Release Package
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: OPC_DA_Agent_Windows_XP_NET40
        path: OPC_DA_Agent_Windows_XP_NET40.zip
        retention-days: 365
